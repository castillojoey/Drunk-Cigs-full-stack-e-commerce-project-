<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Shopping Cart</title>
    <link rel="stylesheet" href="assets/css/styles.css" />
    <link rel="icon" type="image/png" href="assets/images/icon.png" />
  </head>
  <body>
    <header>
      <h1>Your Cart</h1>
      <nav>
        <a href="index.html">Home</a>
        <a href="shop.html">Shop</a>
        <a href="contact.html">Contact</a>
      </nav>
    </header>

    <div id="cart-items"></div>

    <div class="cart-summary">
      <span>Total:</span>
      <span id="cart-total">$0.00</span>
    </div>

    <!-- New checkout button -->
    <button id="checkout-btn" class="btn btn-primary checkout-btn">
      Checkout
    </button>

    <div id="toast-container"></div>

    <div id="cart-sidebar-backdrop" class="cart-sidebar-backdrop">
      <aside id="cart-sidebar" class="cart-sidebar">
        <header class="cart-sidebar-header">
          <h2>Your Cart</h2>
          <button
            type="button"
            id="cart-sidebar-close"
            class="icon-button"
            aria-label="Close cart"
          >
            âœ•
          </button>
        </header>

        <div id="cart-sidebar-items" class="cart-sidebar-items"></div>

        <footer class="cart-sidebar-footer">
          <div class="cart-sidebar-total-row">
            <span>Total:</span>
            <span id="cart-sidebar-total">$0.00</span>
          </div>
          <a
            href="cart.html"
            class="btn btn-primary"
            style="width: 100%; text-align: center"
          >
            View full cart
          </a>
        </footer>
      </aside>
    </div>

    <script src="assets/js/product.js"></script>
    <script src="assets/js/cart.js"></script>
    <script>
      const checkoutBtn = document.getElementById("checkout-btn");

      if (checkoutBtn) {
        checkoutBtn.addEventListener("click", async () => {
          const raw = localStorage.getItem("cart");
          const cart = raw ? JSON.parse(raw) : [];

          if (!cart.length) {
            if (typeof showToast === "function") {
              showToast("Your cart is empty.");
            } else {
              alert("Your cart is empty.");
            }
            return;
          }

          try {
            const res = await fetch(
              "http://localhost:4242/create-checkout-session",
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ cart }),
              }
            );

            const data = await res.json();

            if (data.url) {
              // send the user to Stripe Checkout
              window.location = data.url;
            } else {
              console.error("No URL from backend:", data);
              if (typeof showToast === "function") {
                showToast("Could not start checkout. Check server logs.");
              } else {
                alert("Could not start checkout. Check server logs.");
              }
            }
          } catch (err) {
            console.error("Checkout error:", err);
            if (typeof showToast === "function") {
              showToast("Network error talking to checkout server.");
            } else {
              alert("Network error talking to checkout server.");
            }
          }
        });
      }
    </script>
  </body>
</html>
